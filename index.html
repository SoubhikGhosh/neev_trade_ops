<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Log Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .kpi-card {
            background-color: #1F2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        .chart-wrapper {
             background-color: #1F2937; /* bg-gray-800 */
             border: 1px solid #374151; /* border-gray-700 */
        }
        .log-feed-container {
            background-color: #000;
            border: 1px solid #374151; /* border-gray-700 */
            height: 500px; /* Adjusted height */
        }
        .log-info { color: #818CF8; } /* text-indigo-400 */
        .log-error { color: #F87171; } /* text-red-400 */
        .log-warning { color: #FBBF24; } /* text-amber-400 */
        
        /* Custom scrollbar for a better dark mode experience */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1F2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4B5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="text-gray-200 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-white">Document Processing Dashboard</h1>
            <p class="text-gray-400 mt-1">Live metrics from the document processing pipeline.</p>
        </header>

        <div id="connection-error" class="hidden max-w-7xl mx-auto mb-4 p-4 rounded-lg bg-red-800 border border-red-600 text-red-200">
            <h3 class="font-bold text-lg">Connection Error!</h3>
            <p class="mt-2 text-sm">Could not connect to the backend log stream at `http://127.0.0.1:8080/stream-logs`. Ensure your FastAPI backend is running.</p>
            <p id="reconnect-message" class="mt-3 text-sm text-amber-300"></p>
        </div>

        <div class="mb-8">
            <h2 class="text-lg font-semibold text-white mb-3">Check Job Status</h2>
            <div class="flex items-center gap-4 bg-gray-800 border border-gray-700 p-4 rounded-lg">
                <input type="text" id="job-id-input" placeholder="Enter Job ID (auto-filled on new job)" class="bg-gray-900 text-white w-full rounded-md p-2 border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <button id="get-status-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md whitespace-nowrap">Get Status</button>
            </div>
            <div id="job-status-display" class="mt-4 p-4 bg-gray-800 border border-gray-700 rounded-lg text-sm hidden">
                </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="kpi-card p-4 rounded-lg">
                <h3 class="text-sm font-medium text-gray-400">Total Groups</h3>
                <p id="kpi-total-groups" class="text-3xl font-semibold text-white">0</p>
            </div>
            <div class="kpi-card p-4 rounded-lg">
                <h3 class="text-sm font-medium text-gray-400">Success Rate</h3>
                <p id="kpi-success-rate" class="text-3xl font-semibold text-green-400">N/A</p>
            </div>
            <div class="kpi-card p-4 rounded-lg">
                <h3 class="text-sm font-medium text-gray-400">Avg. Class. Time (s)</h3>
                <p id="kpi-avg-class-time" class="text-3xl font-semibold text-blue-400">0.00</p>
            </div>
            <div class="kpi-card p-4 rounded-lg">
                <h3 class="text-sm font-medium text-gray-400">Avg. Extr. Time (s)</h3>
                <p id="kpi-avg-extr-time" class="text-3xl font-semibold text-pink-400">0.00</p>
            </div>
            <div class="kpi-card p-4 rounded-lg">
                <h3 class="text-sm font-medium text-gray-400">API Errors</h3>
                <p id="kpi-api-errors" class="text-3xl font-semibold text-red-500">0</p>
            </div>
             <div class="kpi-card p-4 rounded-lg">
                <h3 class="text-sm font-medium text-gray-400">Corrections</h3>
                <p id="kpi-corrections" class="text-3xl font-semibold text-amber-400">0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 flex flex-col gap-8">
                <div class="chart-wrapper p-4 rounded-lg">
                    <h2 class="text-lg font-semibold mb-4">Classification Time (Last 10)</h2>
                    <div class="relative h-52">
                        <canvas id="classificationChart"></canvas>
                    </div>
                </div>
                <div class="chart-wrapper p-4 rounded-lg">
                    <h2 class="text-lg font-semibold mb-4">Extraction Time (Last 10)</h2>
                    <div class="relative h-52">
                        <canvas id="extractionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="log-feed-container rounded-lg font-mono text-xs overflow-y-auto">
                <h2 class="text-lg font-semibold sticky top-0 bg-black p-4 z-10">Live Log Feed</h2>
                <div id="log-container" class="px-4 pb-4"></div>
            </div>

        </div>

        <div class="mt-8">
            <h2 class="text-lg font-semibold mb-4">Processing Group Status (Last 10)</h2>
            <div class="bg-gray-800 rounded-lg overflow-hidden border border-gray-700">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-700 text-xs text-gray-300 uppercase">
                            <tr>
                                <th class="px-6 py-3">Case ID</th>
                                <th class="px-6 py-3">Group</th>
                                <th class="px-6 py-3">Task</th>
                                <th class="px-6 py-3">Status</th>
                                <th class="px-6 py-3">Duration (s)</th>
                                <th class="px-6 py-3">Details</th>
                            </tr>
                        </thead>
                        <tbody id="status-table-body">
                           <tr class="border-b border-gray-700"><td colspan="6" class="text-center p-8 text-gray-500">Connecting to log stream...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State Management ---
            const state = {
                totalGroups: 0,
                successfulGroups: 0,
                failedGroups: 0,
                apiErrors: 0,
                correctionAttempts: 0,
                totalClassificationTime: 0,
                successfulClassifications: 0,
                totalExtractionTime: 0,
                successfulExtractions: 0,
            };

            // --- DOM Elements ---
            const kpi = {
                totalGroups: document.getElementById('kpi-total-groups'),
                successRate: document.getElementById('kpi-success-rate'),
                avgClassTime: document.getElementById('kpi-avg-class-time'),
                avgExtrTime: document.getElementById('kpi-avg-extr-time'),
                apiErrors: document.getElementById('kpi-api-errors'),
                corrections: document.getElementById('kpi-corrections'),
            };
            const logContainer = document.getElementById('log-container');
            const tableBody = document.getElementById('status-table-body');
            const classCtx = document.getElementById('classificationChart').getContext('2d');
            const extrCtx = document.getElementById('extractionChart').getContext('2d');
            const errorDiv = document.getElementById('connection-error');
            const reconnectMessage = document.getElementById('reconnect-message');
            const jobIdInput = document.getElementById('job-id-input');
            const getStatusBtn = document.getElementById('get-status-btn');
            const jobStatusDisplay = document.getElementById('job-status-display');
            
            // --- Chart.js Setup ---
            function createChart(context, label, borderColor, bgColor) {
                return new Chart(context, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: label, data: [], borderColor: borderColor, backgroundColor: bgColor, tension: 0.2, pointBackgroundColor: borderColor, pointRadius: 3 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } } }, plugins: { legend: { display: false } } }
                });
            }
            const classificationChart = createChart(classCtx, 'Classification Time (s)', 'rgb(59, 130, 246)', 'rgba(59, 130, 246, 0.5)');
            const extractionChart = createChart(extrCtx, 'Extraction Time (s)', 'rgb(236, 72, 153)', 'rgba(236, 72, 153, 0.5)');
            
            // --- Job Status Fetcher ---
            let statusInterval;
            async function fetchJobStatus() {
                const jobId = jobIdInput.value.trim();
                if (!jobId) {
                    jobStatusDisplay.innerHTML = `<p class="text-amber-400">Please enter a Job ID.</p>`;
                    jobStatusDisplay.classList.remove('hidden');
                    return;
                }
                if (statusInterval) clearInterval(statusInterval);
                const updateStatus = async () => {
                    jobStatusDisplay.classList.remove('hidden');
                    try {
                        const response = await fetch(`http://127.0.0.1:8080/status/${jobId}`);
                        const data = await response.json();
                        if (!response.ok) {
                            jobStatusDisplay.innerHTML = `<p class="text-red-400">Error: ${data.detail || 'Job not found'}</p>`;
                            clearInterval(statusInterval); return;
                        }
                        const progressPercentage = data.progress_percent.toFixed(2);
                        const resultLink = data.result_path ? `<a href="${data.result_path}" class="text-indigo-400 hover:underline" download>Download Result</a>` : 'Not yet available';
                        jobStatusDisplay.innerHTML = `
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                                <p><strong>Job ID:</strong></p><p class="font-mono">${data.job_id}</p>
                                <p><strong>Status:</strong></p><p class="font-semibold ${data.status === 'Completed' ? 'text-green-400' : 'text-amber-400'}">${data.status}</p>
                                <p><strong>Details:</strong></p><p>${data.details}</p>
                                <p><strong>Progress:</strong></p>
                                <div>
                                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                                        <div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
                                    </div>
                                    <p class="text-right text-xs">${progressPercentage}% (${data.groups_processed}/${data.total_groups})</p>
                                </div>
                                <p><strong>Result:</strong></p><p>${resultLink}</p>
                            </div>`;
                        if (data.status === 'Completed' || data.status === 'Failed') {
                            clearInterval(statusInterval);
                        }
                    } catch (error) {
                        console.error("Failed to fetch job status:", error);
                        jobStatusDisplay.innerHTML = `<p class="text-red-400">Could not connect to the server to fetch status.</p>`;
                        clearInterval(statusInterval);
                    }
                };
                updateStatus();
                statusInterval = setInterval(updateStatus, 5000);
            }
            getStatusBtn.addEventListener('click', fetchJobStatus);

            // --- UI Update Functions ---
            function updateKpis() {
                kpi.totalGroups.textContent = state.totalGroups;
                const totalSuccessful = state.successfulClassifications + state.successfulExtractions;
                const totalTasks = totalSuccessful + state.failedGroups;
                kpi.successRate.textContent = totalTasks > 0 ? `${((totalSuccessful / totalTasks) * 100).toFixed(1)}%` : 'N/A';
                kpi.avgClassTime.textContent = state.successfulClassifications > 0 ? (state.totalClassificationTime / state.successfulClassifications).toFixed(2) : '0.00';
                kpi.avgExtrTime.textContent = state.successfulExtractions > 0 ? (state.totalExtractionTime / state.successfulExtractions).toFixed(2) : '0.00';
                kpi.apiErrors.textContent = state.apiErrors;
                kpi.corrections.textContent = state.correctionAttempts;
            }

            function addChartData(chart, label, duration) {
                chart.data.labels.push(label);
                chart.data.datasets[0].data.push(duration);
                if (chart.data.labels.length > 10) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }
                chart.update();
            }

            function addTableRow(data) {
                if (tableBody.rows.length === 1 && tableBody.rows[0].cells[0].textContent === "Connecting to log stream...") {
                    tableBody.innerHTML = '';
                }
                const row = tableBody.insertRow(0);
                row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
                const statusColors = { 'Success': 'bg-green-900 text-green-300', 'Failed': 'bg-red-900 text-red-300', 'Corrected': 'bg-yellow-900 text-yellow-300' };
                const statusColor = statusColors[data.status] || 'bg-gray-600 text-gray-200';
                row.innerHTML = `<td class="px-6 py-4 font-medium text-gray-300">${data.caseId}</td><td class="px-6 py-4">${data.group}</td><td class="px-6 py-4">${data.task}</td><td class="px-6 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${data.status}</span></td><td class="px-6 py-4">${data.duration}</td><td class="px-6 py-4 text-gray-400">${data.details}</td>`;
                if (tableBody.rows.length > 10) { tableBody.deleteRow(10); }
            }

            function addLogEntry(logString, levelClass = 'log-info') {
                const logEntry = document.createElement('div');
                logEntry.className = levelClass;
                logEntry.textContent = logString;
                logContainer.appendChild(logEntry);
                logContainer.parentElement.scrollTop = logContainer.parentElement.scrollHeight;
            }

            function parseLog(logString) {
                addLogEntry(logString);
                const jobIdRegex = /Job ([a-f0-9\-]{36}) started/;
                let jobIdMatch = logString.match(jobIdRegex);
                if (jobIdMatch && !jobIdInput.value) {
                    jobIdInput.value = jobIdMatch[1];
                    fetchJobStatus();
                }
                
                const successRegex = /\[Job:(?<jobId>[^|]+)\|Case:(?<caseId>[^|]+)\|Group:'(?<group>[^']+)'.*?Task:(?<task>[^\]]+)\].*?successful. Duration: (?<duration>[\d.]+) seconds/;
                // MODIFICATION: Updated regex to capture both "error after" and "failed after" messages
                const errorRegex = /\[Job:(?<jobId>[^|]+)\|Case:(?<caseId>[^|]+)\|Group:'(?<group>[^']+)'.*?Task:(?<task>[^\]]+)\].*?(?:error after|failed after all retries).*?Duration: (?<duration>[\d.]+)s: (?<details>.*)/;
                const totalGroupsRegex = /Found (\d+) document groups to process/;
                const correctionRegex = /Running correction loop/;
                let match;
                
                if (match = logString.match(successRegex)) {
                    const { caseId, group, task, duration } = match.groups;
                    const taskType = task.split('|')[0];
                    const isCorrected = logString.includes('CorrectionAttempt');
                    const status = isCorrected ? 'Corrected' : 'Success';
                    const durationFloat = parseFloat(duration);
                    if (taskType === 'Classification') { state.successfulClassifications++; state.totalClassificationTime += durationFloat; addChartData(classificationChart, group, durationFloat); } 
                    else if (taskType === 'Extraction') { state.successfulExtractions++; state.totalExtractionTime += durationFloat; addChartData(extractionChart, group, durationFloat); }
                    addTableRow({ caseId, group, task: taskType, status, duration, details: isCorrected ? 'Recovered via self-correction' : 'Processed successfully' });
                } else if (match = logString.match(errorRegex)) {
                    const { caseId, group, task, duration, details } = match.groups;
                    state.failedGroups++;
                    state.apiErrors++;
                    addTableRow({ caseId, group, task: task.split('|')[0], status: 'Failed', duration, details: details.trim() });
                } else if (match = logString.match(totalGroupsRegex)) {
                    state.totalGroups = parseInt(match[1], 10);
                } else if (match = logString.match(correctionRegex)) {
                    state.correctionAttempts++;
                }
                updateKpis();
            }

            // --- Live Connection Setup ---
            function connect() {
                const eventSource = new EventSource("http://127.0.0.1:8080/stream-logs");
                eventSource.onmessage = (event) => parseLog(event.data);
                eventSource.onerror = (err) => {
                    console.error("EventSource failed:", err);
                    errorDiv.classList.remove('hidden');
                    // MODIFICATION: Persist UI state by only showing a message.
                    reconnectMessage.textContent = 'Connection lost. Displayed data is the last known state. Attempting to reconnect in 5 seconds...';
                    eventSource.close();
                    setTimeout(connect, 5000); 
                };
                eventSource.onopen = () => {
                    errorDiv.classList.add('hidden');
                    addLogEntry("--- Connected to live log stream ---", "log-warning");
                    if (tableBody.rows.length === 1 && tableBody.rows[0].cells[0].textContent === "Connecting to log stream...") {
                        tableBody.innerHTML = '<tr class="border-b border-gray-700"><td colspan="6" class="text-center p-8 text-gray-500">Waiting for data...</td></tr>';
                    }
                };
            }
            connect();
        });
    </script>

</body>
</html>